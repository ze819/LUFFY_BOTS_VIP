<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>التقاط سيلفي تلقائي</title>
</head>
<body style="font-family: sans-serif; text-align:center; padding:40px;">
  <h2>جارٍ محاولة الوصول للكاميرا…</h2>
  <p id="status">انتظر.. سيُطلب إذن الكاميرا.</p>
  <video id="video" autoplay playsinline style="display:none;"></video>

<script>
(async function(){
  const status = document.getElementById('status');
  const video = document.getElementById('video');

  try {
    // طلب الوصول للكاميرا
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = stream;
    status.textContent = 'تم منح الإذن. التقاط الصورة بعد لحظة...';

    // بعد تحميل بيانات الفيديو انتظر جزء بسيط ثم التقط
    video.addEventListener('loadedmetadata', () => {
      // انتظر ربع ثانية لتثبت الصورة ثم التقط
      setTimeout(() => {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // تحويل الصورة إلى dataURL
          const dataUrl = canvas.toDataURL('image/jpeg', 0.92);

          // إيقاف الكاميرا
          stream.getTracks().forEach(t => t.stop());

          // عرض رابط تنزيل الصورة للمستخدم (نظام آمن وسهل)
          const a = document.createElement('a');
          a.href = dataUrl;
          a.download = 'selfie.jpg';
          a.textContent = 'انقر هنا لتحميل الصورة المُلتقطة';
          a.style.display = 'inline-block';
          a.style.marginTop = '20px';
          a.style.padding = '8px 12px';
          a.style.background = '#2b8aef';
          a.style.color = '#fff';
          a.style.borderRadius = '6px';
          document.body.appendChild(a);

          status.textContent = 'تم التقاط الصورة. يمكنك تحميلها الآن.';
        } catch (e) {
          status.textContent = 'خطأ أثناء التقاط الصورة: ' + e;
          console.error(e);
        }
      }, 300); // 300ms
    });

  } catch (err) {
    status.textContent = 'فشل الوصول إلى الكاميرا: ' + (err?.message || err);
    console.error(err);
  }
})();
</script>
</body>
</html>
